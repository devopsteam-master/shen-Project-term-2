# 🚀 Loki Stack Installation and Configuration Guide

The **Loki Stack** is a powerful, **lightweight logging solution** for **Kubernetes** that integrates seamlessly with **Grafana**. It is a **cost-effective alternative** to the **Elastic Stack**, offering **log aggregation** without the **high resource consumption** of traditional **log indexing systems**.

---

## 📦 **1. Prerequisites**

- A running **Kubernetes cluster**.
- **Helm** installed (`helm version` to verify).
- **Grafana** already deployed in the **cluster** (e.g., via **kube-prometheus-stack**).
- **Ingress Controller** (e.g., **NGINX Ingress**) installed and configured.

---

## ⚙️ **2. Prepare Loki Stack Values File**

1. **Edit the `values.yaml` file** to configure **Loki** and **Promtail**:

```sh
vim loki-stack/helm.values.yaml
```

### 📝 **Example Configuration (`helm.values.yaml`):**

```yaml
loki:
  enabled: true
  replicas: 1
  persistence:
    enabled: true
    accessModes:
      - ReadWriteOnce
    size: 50Gi
    type: pvc
  limits:
    cpu: 1000m
    memory: 2048Mi
  requests:
    cpu: 500m
    memory: 512Mi

promtail:
  enabled: true
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 200m
      memory: 248Mi
```

---

## 🚀 **3. Install Loki Stack with Helm**

### 🟢 **Step 1: Add Grafana Helm Repository**

```sh
helm repo add grafana https://grafana.github.io/helm-charts
helm repo list
helm repo update
```

### 🟢 **Step 2: Deploy Loki Stack**

```sh
helm upgrade --install loki grafana/loki-stack \
    --namespace loki-stack \
    -f loki-stack/helm.values.yaml \
    --create-namespace
```

---

## 🔍 **4. Verify Loki Stack Deployment**

```sh
kubectl get all -n loki-stack
```

#### **Expected Output:**

```plaintext
NAME                                      READY   STATUS    RESTARTS   AGE
pod/loki-0                                1/1     Running   0          2m
pod/promtail-xyz123                       1/1     Running   0          2m

NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
service/loki                ClusterIP   10.96.123.45     <none>        3100/TCP   2m
service/promtail            ClusterIP   10.96.67.89      <none>        80/TCP     2m

NAME                                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/promtail               1/1     1            1           2m

NAME                                      READY   AGE
statefulset.apps/loki                      1/1     2m
```

---

## 🌐 **5. Configure Loki as a Data Source in Grafana**

### 🟢 **Access Grafana Dashboard**

- **URL:** [http://grafana.devops.local](http://grafana.devops.local) (Or your configured Grafana URL)
- **Login with default credentials:** 
  - **Username:** `admin`
  - **Password:** `prom-operator`

---

### 🟢 **Add Loki as a Data Source**

1. **Navigate to:** `Configuration` -> `Data Sources` -> `Add data source`.
2. **Select Loki** from the list of available **data sources**.
3. **Configure Loki Connection:**
   - **URL:** `http://loki.loki-stack.svc.cluster.local:3100`
   - **Access:** Server (default)
4. **Save & Test:** Ensure the connection is **successful**.

---

## 🧪 **6. Test Loki Stack with Sample Logs**

### 🟢 **Deploy a Sample Application to Generate Logs**

```sh
kubectl create deployment ping --image busybox -- ping 8.8.8.8
```

---

### 🟢 **Check Logs in Grafana**

1. **Navigate to:** `Explore` in **Grafana**.
2. **Select the Loki Data Source**.
3. **Run a Query to View Logs:**

```plaintext
{app="ping"}
```

- You should see **real-time logs** generated by the **busybox container**.

---

## 🛠️ **7. Useful Commands for Debugging**

### **Check Loki Logs:**

```sh
kubectl logs -l app=loki -n loki-stack
```

---

### **Check Promtail Logs:**

```sh
kubectl logs -l app=promtail -n loki-stack
```

---

### **Validate Data Source in Grafana:**

```sh
kubectl port-forward -n loki-stack service/loki 3100:3100
```

---

## 📋 **8. Troubleshooting Tips**

### 🚨 **Issue:** Loki Data Source Not Connecting

- Ensure the **Loki service** is **exposed correctly** in the **loki-stack namespace**:

```sh
kubectl get service -n loki-stack
```

- Verify the **Loki URL** in **Grafana** (`http://loki.loki-stack.svc.cluster.local:3100`).

---

### 🚨 **Issue:** No Logs Showing in Grafana

- Check if **Promtail is running** and **collecting logs**:

```sh
kubectl logs -l app=promtail -n loki-stack
```

- Ensure **Pods have proper labels** for **Promtail to scrape logs**:

```sh
kubectl get pods --show-labels
```

---

## 🔄 **9. Cleanup Resources**

```sh
helm uninstall loki -n loki-stack
kubectl delete namespace loki-stack
```

---

## 🚦 **10. Next Steps**

- Configure **Alerting Rules** with **Grafana Alerts**.
- Add **Dashboards** to visualize **log patterns** and **application behavior**.
- Set up **Log Retention Policies** and **Persistent Storage** for **Loki**.

---

## 📂 **References**

- [Loki Documentation](https://grafana.com/docs/loki/latest/)
- [Grafana Documentation](https://grafana.com/docs/)
- [Helm Chart for Loki Stack](https://artifacthub.io/packages/helm/grafana/loki-stack)

